[workspace]
name = "Aquatones-ALETHEIA"
authors = ["yukishige.kawaguchi"]
channels = ["https://conda.modular.com/max", "conda-forge", "nvidia"]
platforms = ["linux-64"]

[dependencies]
openblas = ">=0.3.20"
libcblas = ">=3.9.0"
liblapack = ">=3.9.0"
liblapacke = ">=3.9.0"
libgomp = "*"
gcc_linux-64 = "11.*"
gxx_linux-64 = "11.*"
cmake = "*"
make = "*"
clang = ">=21.1.8"
pkg-config = "*"
modular = ">=25.1"
python = "3.10.*"
numpy = ">=1.26"
matplotlib = ">=3.10.8"
h5py = ">=3.15.1"
cuda-toolkit = ">=12.0"
cuda-nvcc = ">=12.0"
cuda-version = "12.9.*"
git = "*"
wget = "*"

[pypi-dependencies]
lean-dojo = "*"

[system-requirements]
cuda = "12.9"

[tasks]
build-cuda = "nvcc -Xcompiler -fPIC -shared -arch=sm_90 cuda/src/kernel.cu -o mojo/libvoxel_cuda.so"

# SciLeanビルド: 環境変数をテーブル形式で分離して記述
[tasks.build-scilean]
cmd = "lake build"
cwd = "SciLean"
env = { CPATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/include", LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/lib", LD_LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/lib:$LD_LIBRARY_PATH" }

[tasks.build-lean]
cmd = "lake build PhysicsOracle"
env = { CPATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/include", LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/lib", LD_LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/lib:$LD_LIBRARY_PATH" }

[tasks.build-bridge]
cmd = "mkdir -p build && cd build && cmake .. && make"
env = { CPATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/include", LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/default/lib", LD_LIBRARY_PATH = "$HOME/.elan/toolchains/leanprover--lean4---v4.20.1/lib/lean:$PIXI_PROJECT_ROOT/.pixi/envs/default/lib" }

[tasks.run]
depends-on = ["build-cuda", "build-scilean", "build-lean", "build-bridge"]
cmd = "mojo mojo/main.mojo"
