ついに `physics_test` および `libPhysicsOracleBridge.so` のビルドが完全に成功しました！14,000ファイルを超える巨大な依存関係と、複雑なシンボル未解決問題を乗り越えた、この極めて重要なビルドプロセスをドキュメントとしてまとめます。

---

# 📝 技術ドキュメント：Lean 4 / C++ ハイブリッド・監査エンジンの構築記録

## 1. プロジェクトの目的

航空監査における物理演算の正当性を証明するため、**Lean 4 (SciLean)** で記述された形式仕様を、**C++ ブリッジ** を通じて **Mojo / CUDA** 環境へ統合する。

## 2. 環境構成と主要パス

* **OS**: Linux (x86_64)
* **Compiler**: GCC 11.4.0 (via Pixi)
* **Lean Version**: 4.20.1 (via Elan)
* **依存ライブラリ**:
* `SciLean`: 物理演算・自動微分
* `LeanBLAS`: 行列計算インターフェース
* `OpenBLAS`: 高速数値計算バックエンド (Pixi 環境)



## 3. ビルド・プロセスの核心的解決策

今回のビルド成功において、特に重要だった技術的判断は以下の通りです。

### A. 環境変数の制御 (Pixi + Elan)

ビルド中に Lean が自分自身の共有ライブラリや OpenBLAS を見失わないよう、`LD_LIBRARY_PATH` を多層的に構成しました。

* **追加パス1**: `$HOME/.elan/toolchains/.../lib/lean` (Lean ランタイム)
* **追加パス2**: `$PIXI_PROJECT_ROOT/.pixi/envs/default/lib` (OpenBLAS/GCC ランタイム)

### B. シンボル未解決問題の物理的解決

`l_BLAS_Float64Array_size___boxed` 等の Lean 特有のボクシングシンボルが共有ライブラリ間で解決できない問題を、**`CMake` における絶対パス指定のリンク** によって解決しました。

* **手法**: `target_link_libraries` において、`libSciLean.so` や `libLeanBLAS.so` をプロジェクトディレクトリからの絶対パスで直接指定し、リンカが確実にシンボルを走査できるように設定しました。

---

## 4. 最終的な CMake 構成 (安定版)

以下の設定により、ターゲット `physics_test` と Mojo 用の `libPhysicsOracleBridge.so` を生成しました。

```cmake
# ターゲットと依存関係の定義
add_executable(physics_test src/main.cpp src/bridge.cpp ${LEAN_OBJ})

# 絶対パスによる強固なリンク
target_link_libraries(physics_test
    "${CMAKE_CURRENT_SOURCE_DIR}/.lake/packages/scilean/.lake/build/lib/libSciLean.so"
    "${CMAKE_CURRENT_SOURCE_DIR}/.lake/packages/leanblas/.lake/build/lib/libLeanBLAS.so"
    "${LEAN_ROOT}/lib/lean/libLake_shared.so"
    leanshared openblas pthread dl
)

```

## 5. 成果物

* **`build/physics_test`**: C++ から Lean 4 ロジックを呼び出すテスト用バイナリ。
* **`build/libPhysicsOracleBridge.so`**: Mojo の `dlopen` でロード可能な統合監査ライブラリ。

---

## 🚀 次のステップ：最終確認の実行

ドキュメントの通り、環境変数を整えて実行します。シンボルエラーを完全に封じ込めるため、ライブラリパスを明示的に指定して起動してください。

```bash
# 1. 共有ライブラリのパスをカレント（build）含め設定
export LEANBLAS_SO_DIR=/home/yukishige.kawaguchi/workspace/YuXiGe/Aquatones-ALETHEIA/.lake/packages/leanblas/.lake/build/lib
export SCILEAN_SO_DIR=/home/yukishige.kawaguchi/workspace/YuXiGe/Aquatones-ALETHEIA/.lake/packages/scilean/.lake/build/lib
export LEAN_RT_DIR=$HOME/.elan/toolchains/leanprover--lean4---v4.20.1/lib/lean

export LD_LIBRARY_PATH=$(pwd):$LEAN_RT_DIR:$LEANBLAS_SO_DIR:$SCILEAN_SO_DIR:/home/yukishige.kawaguchi/workspace/YuXiGe/Aquatones-ALETHEIA/.pixi/envs/default/lib:$LD_LIBRARY_PATH

# 2. 実行
./physics_test

```

**「Verified Result: 1.0」と表示されれば、この開発フェーズは完全勝利です！** 実行結果を教えていただけますか？